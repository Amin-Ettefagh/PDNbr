import oracledb

CONFIG = {
    "host": "192.168.1.10",
    "port": 1521,
    "service_name": "ORCLPDB1",
    "username": "APP_USER",
    "password": "PASSWORD"
}

OUTPUT_FILE = "oracle_dump.txt"

def write(line):
    with open(OUTPUT_FILE, "a", encoding="utf-8") as f:
        f.write(line + "\n")

def log_error(title, error):
    write(f"ERROR | {title} | {error}")

def connect_oracle(cfg):
    try:
        dsn = oracledb.makedsn(cfg["host"], cfg["port"], service_name=cfg["service_name"])
        return oracledb.connect(user=cfg["username"], password=cfg["password"], dsn=dsn)
    except Exception as e:
        log_error("CONNECTION_ERROR", e)
        return None

def get_accessible_schemas(conn):
    try:
        cur = conn.cursor()
        cur.execute("SELECT DISTINCT owner FROM all_tables ORDER BY owner")
        return [r[0] for r in cur.fetchall()]
    except Exception as e:
        log_error("SCHEMA_LIST_ERROR", e)
        return []

def get_tables_by_schema(conn, schema):
    try:
        cur = conn.cursor()
        cur.execute("SELECT table_name FROM all_tables WHERE owner = :s ORDER BY table_name", s=schema)
        return [r[0] for r in cur.fetchall()]
    except Exception as e:
        log_error(f"TABLE_LIST_ERROR {schema}", e)
        return []

def get_columns(conn, schema, table):
    cur = conn.cursor()
    cur.execute(
        "SELECT column_name, data_type FROM all_tab_columns WHERE owner=:s AND table_name=:t ORDER BY column_id",
        s=schema, t=table
    )
    return cur.fetchall()

def get_table_count(conn, schema, table):
    cur = conn.cursor()
    cur.execute(f"SELECT COUNT(*) FROM {schema}.{table}")
    return cur.fetchone()[0]

def get_column_sample(conn, schema, table, column):
    cur = conn.cursor()
    cur.execute(f"""
        SELECT {column}
        FROM {schema}.{table}
        WHERE {column} IS NOT NULL
        FETCH FIRST 1 ROWS ONLY
    """)
    row = cur.fetchone()
    return row[0] if row else None

def run():
    open(OUTPUT_FILE, "w", encoding="utf-8").close()

    conn = connect_oracle(CONFIG)
    if not conn:
        return

    schemas = get_accessible_schemas(conn)
    write(f"SCHEMA_COUNT: {len(schemas)}")

    for schema in schemas:
        write("=" * 80)
        write(f"SCHEMA: {schema}")

        tables = get_tables_by_schema(conn, schema)
        write(f"TABLE_COUNT: {len(tables)}")

        for table in tables:
            write("-" * 60)
            write(f"TABLE: {schema}.{table}")

            try:
                total_records = get_table_count(conn, schema, table)
                write(f"TOTAL_RECORDS: {total_records}")
            except Exception as e:
                log_error(f"COUNT_ERROR {schema}.{table}", e)
                continue

            try:
                columns = get_columns(conn, schema, table)
                write(f"COLUMN_COUNT: {len(columns)}")

                for col_name, col_type in columns:
                    try:
                        sample = get_column_sample(conn, schema, table, col_name)
                        write(f"FIELD: {col_name} | TYPE: {col_type} | SAMPLE: {sample}")
                    except Exception as e:
                        log_error(f"SAMPLE_ERROR {schema}.{table}.{col_name}", e)

            except Exception as e:
                log_error(f"COLUMN_ERROR {schema}.{table}", e)

    conn.close()
    write("END_OF_DUMP")

run()
