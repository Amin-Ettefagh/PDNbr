import oracledb

CONFIG = {
    "host": "192.168.1.10",
    "port": 1521,
    "service_name": "ORCLPDB1",
    "username": "APP_USER",
    "password": "PASSWORD"
}

def log_error(title, error):
    print(title)
    print(str(error))

def connect_oracle(cfg):
    try:
        dsn = oracledb.makedsn(cfg["host"], cfg["port"], service_name=cfg["service_name"])
        return oracledb.connect(user=cfg["username"], password=cfg["password"], dsn=dsn)
    except Exception as e:
        log_error("CONNECTION_ERROR", e)
        return None

def get_accessible_schemas(conn):
    try:
        cur = conn.cursor()
        cur.execute("SELECT DISTINCT owner FROM all_tables ORDER BY owner")
        return [r[0] for r in cur.fetchall()]
    except Exception as e:
        log_error("SCHEMA_LIST_ERROR", e)
        return []

def get_tables_by_schema(conn, schema):
    try:
        cur = conn.cursor()
        cur.execute("SELECT table_name FROM all_tables WHERE owner = :s ORDER BY table_name", s=schema)
        return [r[0] for r in cur.fetchall()]
    except Exception as e:
        log_error(f"TABLE_LIST_ERROR {schema}", e)
        return []

def get_columns(conn, schema, table):
    try:
        cur = conn.cursor()
        cur.execute(
            "SELECT column_name, data_type FROM all_tab_columns WHERE owner=:s AND table_name=:t ORDER BY column_id",
            s=schema, t=table
        )
        return cur.fetchall()
    except Exception as e:
        return f"COLUMN_ERROR {schema}.{table}: {e}"

def get_records(conn, schema, table, limit=10):
    try:
        cur = conn.cursor()
        cur.execute(f"SELECT * FROM {schema}.{table} FETCH FIRST {limit} ROWS ONLY")
        return cur.fetchall()
    except Exception as e:
        return f"RECORD_ERROR {schema}.{table}: {e}"

def run():
    conn = connect_oracle(CONFIG)
    if not conn:
        return

    schemas = get_accessible_schemas(conn)
    print("SCHEMA_COUNT:", len(schemas))

    for schema in schemas:
        print("\nSCHEMA:", schema)

        tables = get_tables_by_schema(conn, schema)
        print("TABLE_COUNT:", len(tables))

        for table in tables:
            print("\nTABLE:", f"{schema}.{table}")

            cols = get_columns(conn, schema, table)
            if isinstance(cols, str):
                print(cols)
            else:
                print("COLUMNS:")
                for c in cols:
                    print(c)

            recs = get_records(conn, schema, table)
            if isinstance(recs, str):
                print(recs)
            else:
                print("RECORDS:")
                for r in recs:
                    print(r)

    conn.close()

run()
